<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=Cp1252" />
<script src="../dbdoc.js" type="text/javascript"></script>
<link href="../dbdoc.css" type="text/css" rel="stylesheet">
</head>
<body class="object">
<div id="header"><h2>QUOTE_PERTINENZA_TERZI</h2>
<div class="tabs clearfix">

<div class="tab"><div><a href="QUOTE_PERTINENZA_TERZI.html">Details</a></div></div>
<div class="tab"><div><a href="QUOTE_PERTINENZA_TERZI_Grants.html">Grants</a></div></div>
<div class="tab"><div><a href="QUOTE_PERTINENZA_TERZI_References.html">References</a></div></div>
<div class="tab"><div><a href="QUOTE_PERTINENZA_TERZI_Dependencies.html">Dependencies</a></div></div>
<div class="tab" id="current"><div><a href="QUOTE_PERTINENZA_TERZI_Code.html">Code</a></div></div>
</div></div><br/>
<div class="tab-panes">
<div id="Code"> <table cellpadding="0" cellspacing="0" cellspacing="0" summary=""><tr>
	<th>TEXT</th>
</tr>
	<tr><td><pre>
PROCEDURE QUOTE_PERTINENZA_TERZI (p_anno in number) is 
	ord_riga number := 0;

    codice_PAIIIb number := 0;
	codice_PAIIIc number := 0;
    codice_PAIIId number := 0;


    verifica_PAIIIb number := 0;
    verifica_PAIIIc number := 0;
    verifica_PAIIId number := 0;

    totale_PAIIIb number := 0;
    totale_PAIIIc number := 0;
    totale_PAIIId number := 0;

	-- cursore Fondo di dotazione e riserve di pertinenza di terzi (si espone sul conto PAIIIb la somma degli importi nei conti 'PAI','PAIIa','PAIIb','PAIIc')
	cursor fondo_dotazione is 
	select b.id_ente
	,a.DENOMINAZIONE
	,b.id_conto
	,b.codice_conto
	,b.DESCRIZIONE desc_conto
	,b.importo importo_bilancio
	,nvl((100-nvl(c.PERC_PARTECIPAZIONE,0)),0) perc_pertinenza
	,nvl(round(nvl(b.importo,0)*(100-nvl(c.PERC_PARTECIPAZIONE,0))/100,2),0) imp_pertinenza
	from vw_bilanci_enti_nettizzati b
	,cons_ana_contabile c
	,CONS_ANAGRAFICA a
	where b.anno = p_anno
	and b.CODICE_CONTO in ('PAI','PAIIa','PAIIb','PAIIc','PAIId','PAIIe')
	and nvl(b.importo,0) &lt;> 0
	and c.ID_ANA = b.ID_ENTE
	and c.ANNO = b.ANNO
	and nvl(c.PERC_PARTECIPAZIONE,0) &lt; 100
    and nvl(c.flag_qp,'N') = 'N'
	and a.ID = b.id_ente
    and a.id &lt;> 1
	order by 1;

	-- cursore Risultato economico dell'esercizio di pertinenza di terzi (si espone sul conto PAIIIc e EH28 la somma degli importi sul conto PAIII)
	cursor risultato_es is
	select b.id_ente
	,a.DENOMINAZIONE
	,b.id_conto
	,b.codice_conto
	,b.DESCRIZIONE desc_conto
	,b.importo importo_bilancio
	,nvl((100-nvl(c.PERC_PARTECIPAZIONE,0)),0) perc_pertinenza
	,nvl(round(nvl(totale_conto_netto (p_anno,b.codice_conto, b.id_ente),0)*(100-nvl(c.PERC_PARTECIPAZIONE,0))/100,2),0) imp_pertinenza
	from vw_bilanci_enti_nettizzati b
	,cons_ana_contabile c
	,CONS_ANAGRAFICA a
	where b.anno = p_anno
	and b.CODICE_CONTO = 'PAIII'
	and nvl(b.importo,0) &lt;> 0
	and c.ID_ANA = b.ID_ENTE
	and c.ANNO = b.ANNO
	and nvl(c.PERC_PARTECIPAZIONE,0) &lt; 100
    and nvl(c.flag_qp,'N') in ('N','F')
	and a.ID = b.id_ente
    and a.id &lt;> 1
	order by 1;

begin

	-- inserisco le rettifiche per il Fondo di dotazione e riserve di pertinenza di terzi PAIIIb
		begin
		select id into codice_PAIIIb
		from cons_piacee
		where anno = p_anno
		and codice_conto = 'PAIIIb';
		exception when no_data_found then codice_PAIIIb := 0;
		end;

    -- verifico che non siano già inserite rettificche per il conto PAIIIb
      select nvl(sum(nvl(importo,0)),0) into verifica_PAIIIb
      from cons_rettifiche
      where anno = p_anno
      and codice_conto = codice_PAIIIb
      and nvl(flag_bilancio,'N') = 'C';

	if codice_PAIIIb &lt;> 0 and verifica_PAIIIb = 0
	then	
	 for f in fondo_dotazione loop

	 	select seq_rett.nextval into ord_riga
	 	from dual;
        if f.imp_pertinenza &lt;> 0 then
	 	insert into cons_rettifiche(ANNO,ID_ENTE,CODICE_CONTO,PROGRESSIVO,FLAG_BILANCIO,IMPORTO,NOTE)
	 		values
	 		(p_anno
	 			,f.id_ente
	 			,codice_PAIIIb
	 			,ord_riga
	 			,'C'
	 			,f.imp_pertinenza
	 			,'QPT - Rilevazione Fondo di dotazione e riserve di pertinenza di terzi per '||f.DENOMINAZIONE||' su '||f.codice_conto||' - '||f.desc_conto||' con percentuale di pertinenza di pertinenza di terzi pari a '||f.perc_pertinenza||'%'
	 		);
             commit;
          end if;
      update cons_ana_contabile a set a.flag_qp = 'F' where a.anno = p_anno and a.id_ana = f.id_ente;
      commit;
       totale_PAIIIb := totale_PAIIIb + nvl(f.imp_pertinenza,0);
	 end loop;

	end if;


	-- inserisco le rettifiche per il Risultato d'esercizio di pertinenza di terzi PAIIIc
		begin
		select id into codice_PAIIIc
		from cons_piacee
		where anno = p_anno
		and codice_conto = 'PAIIIc';
		exception when no_data_found then codice_PAIIIc := 0;
		end;

     -- verifico che non siano già inserite rettificche per il conto PAIIIc
      select nvl(sum(nvl(importo,0)),0) into verifica_PAIIIc
      from cons_rettifiche
      where anno = p_anno
      and codice_conto = codice_PAIIIc
      and nvl(flag_bilancio,'N') = 'C';


	if codice_PAIIIc &lt;> 0 and verifica_PAIIIc = 0
	then	
	 for r in risultato_es loop

	 	select seq_rett.nextval into ord_riga
	 	from dual;

        if r.imp_pertinenza &lt;> 0
        then
	 	insert into cons_rettifiche(ANNO,ID_ENTE,CODICE_CONTO,PROGRESSIVO,FLAG_BILANCIO,IMPORTO,NOTE)
	 		values
	 		(p_anno
	 			,r.id_ente
	 			,codice_PAIIIc
	 			,ord_riga
	 			,'C'
	 			,r.imp_pertinenza
	 			,'QPT - Rilevazione Risultato economico di esercizio di pertinenza di terzi per '||r.DENOMINAZIONE||' su '||r.codice_conto||' - '||r.desc_conto||' con percentuale di pertinenza di terzi pari a '||r.perc_pertinenza||'%'
	 		);
            commit;
        end if;
      update cons_ana_contabile a set a.flag_qp = 'S' where a.anno = p_anno and a.id_ana = r.id_ente;
      commit;
       totale_PAIIIc := totale_PAIIIc + nvl(r.imp_pertinenza,0);
	 end loop;

	end if;
    
    -- inserisco le rettifiche per Patrimonio netto di pertinenza di terzi PAIIId
		begin
		select id into codice_PAIIId
		from cons_piacee
		where anno = p_anno
		and codice_conto = 'PAIIId';
		exception when no_data_found then codice_PAIIId := 0;
		end;

    -- verifico che non siano già inserite rettificche per il conto PAIIIb
      select nvl(sum(nvl(importo,0)),0) into verifica_PAIIId
      from cons_rettifiche
      where anno = p_anno
      and codice_conto = codice_PAIIId
      and nvl(flag_bilancio,'N') = 'C';

	if codice_PAIIId &lt;> 0 and verifica_PAIIId = 0
	then	
	    
        totale_PAIIId  := totale_PAIIIb + totale_PAIIIc;
        
	 	select seq_rett.nextval into ord_riga
	 	from dual;
        if totale_PAIIId &lt;> 0 then
	 	insert into cons_rettifiche(ANNO,ID_ENTE,CODICE_CONTO,PROGRESSIVO,FLAG_BILANCIO,IMPORTO,NOTE)
	 		values
	 		(p_anno
	 			,1
	 			,codice_PAIIId
	 			,ord_riga
	 			,'C'
	 			,totale_PAIIId
	 			,'QPT - Rilevazione Patrimonio netto di pertinenza di terzi'
	 		);
             commit;
          end if;
     	
	end if;

end;</pre>	</td></tr>
</table></div>